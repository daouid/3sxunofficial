name: Create Release

on:
  push:
    branches:
      - "main"

jobs:
  build-linux:
    name: Build (Linux x86_64 ${{ matrix.build_type }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Release, Debug]
    container:
      image: ubuntu:25.04
    steps:
      - name: Install Git and tools
        run: |
          apt-get update
          apt-get install -y git curl nasm

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Linux-deps-${{ hashFiles('build-deps.sh') }}

      - name: Install build dependencies
        run: |
          apt-get install -y $(cat tools/requirements-ubuntu-sdl3.txt)
          apt-get install -y clang zip

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          ./build-deps.sh

      - name: Configure and build with CMake
        run: |
          CC=clang CXX=clang++ cmake -B build-${{ matrix.build_type }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build-${{ matrix.build_type }} --parallel

      - name: Package artifact
        run: |
          TYPE_LOWER=$(echo "${{ matrix.build_type }}" | tr 'A-Z' 'a-z')
          SUFFIX=""
          [ "$TYPE_LOWER" = "debug" ] && SUFFIX="-debug"
          mkdir -p artifacts pkg/bin pkg/lib
          cp build-${{ matrix.build_type }}/3sx pkg/bin/
          cp third_party/ffmpeg/build/lib/*.so* pkg/lib/
          cp third_party/sdl3/build/lib/*.so* pkg/lib/
          cp dist/3sx.sh pkg/
          chmod +x pkg/3sx.sh pkg/bin/3sx
          cd pkg && zip -r ../artifacts/3sx-linux-x86_64${SUFFIX}.zip . && cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-linux-x86_64-${{ matrix.build_type }}
          path: artifacts/3sx-linux-x86_64*.zip

  build-linux-arm64:
    name: Build (Linux ARM64 Cross-Compile ${{ matrix.build_type }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Release, Debug]
    container:
      image: ubuntu:25.04
    steps:
      - name: Install Git and cross-compile toolchain
        run: |
          apt-get update
          apt-get install -y git curl xz-utils

          # ARM64 packages live on ports.ubuntu.com, not archive.ubuntu.com.
          dpkg --add-architecture arm64

          # Pin existing DEB822 sources to amd64-only (ubuntu:25.04 format)
          for f in /etc/apt/sources.list.d/*.sources; do
              if [ -f "$f" ] && ! grep -q 'Architectures:' "$f"; then
                  sed -i '/^Types:/a Architectures: amd64' "$f"
              fi
          done

          # Add arm64 sources from ports.ubuntu.com
          printf '%s\n' \
              'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky main restricted universe multiverse' \
              'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-updates main restricted universe multiverse' \
              'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-security main restricted universe multiverse' \
              > /etc/apt/sources.list.d/arm64-ports.list

          apt-get update
          apt-get install -y crossbuild-essential-arm64 cmake ninja-build make pkg-config clang zip file qemu-user-static

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache ARM64 dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Linux-arm64-cross-deps-${{ hashFiles('build-deps.sh') }}

      - name: Install ARM64 build dependencies
        run: |
          apt-get install -y \
            libasound2-dev:arm64 libpulse-dev:arm64 \
            libx11-dev:arm64 libxext-dev:arm64 libxrandr-dev:arm64 \
            libxcursor-dev:arm64 libxfixes-dev:arm64 libxi-dev:arm64 \
            libxrender-dev:arm64 libxinerama-dev:arm64 libxtst-dev:arm64 \
            libxss-dev:arm64 libxkbcommon-dev:arm64 libxkbcommon-x11-dev:arm64 \
            libdrm-dev:arm64 libgbm-dev:arm64 \
            libgl1-mesa-dev:arm64 libgles2-mesa-dev:arm64 \
            libegl1-mesa-dev:arm64 libdbus-1-dev:arm64 libudev-dev:arm64 \
            libpipewire-0.3-dev:arm64 \
            libwayland-dev:arm64 libwayland-egl1:arm64 libdecor-0-dev:arm64 \
            wayland-protocols

      - name: Build FFmpeg (aarch64 cross-compile)
        run: |
          mkdir -p $GITHUB_WORKSPACE/third_party && cd $GITHUB_WORKSPACE/third_party
          mkdir -p ffmpeg && cd ffmpeg
          if [ ! -d "build" ]; then
              FFMPEG="ffmpeg-8.0"
              if [ ! -d "$FFMPEG" ]; then
                  curl -L -O "https://ffmpeg.org/releases/$FFMPEG.tar.xz"
                  tar xf "$FFMPEG.tar.xz"
              fi
              cd "$FFMPEG"
              mkdir -p build && cd build
              ../configure \
                  --prefix="$(pwd)/../../build" \
                  --arch=aarch64 \
                  --target-os=linux \
                  --enable-cross-compile \
                  --cross-prefix=aarch64-linux-gnu- \
                  --disable-x86asm \
                  --disable-all --disable-autodetect \
                  --disable-static --enable-shared \
                  --enable-avcodec --enable-avformat --enable-avutil --enable-swresample \
                  --enable-decoder=adpcm_adx --enable-parser=adx --enable-muxer=adx \
                  --enable-pic --extra-cflags="-fPIC" \
                  --extra-ldflags="-Wl,-rpath,\$ORIGIN/../lib"
              make -j$(nproc)
              make install
          fi

      - name: Build SDL3 (aarch64 cross-compile)
        run: |
          mkdir -p $GITHUB_WORKSPACE/third_party && cd $GITHUB_WORKSPACE/third_party
          mkdir -p sdl3 && cd sdl3
          if [ ! -d "build" ]; then
              SDL="SDL3-3.2.24"
              if [ ! -d "$SDL" ]; then
                  curl -L -O "https://libsdl.org/release/$SDL.tar.gz"
                  tar xf "$SDL.tar.gz"
              fi
              cd "$SDL"
              mkdir -p build && cd build
              # Point pkg-config at arm64 .pc files so SDL3 finds X11/Wayland
              export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
              export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
              cmake .. \
                  -DCMAKE_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/cmake/aarch64-linux-gnu.cmake \
                  -DCMAKE_INSTALL_PREFIX="$(pwd)/../../build" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DSDL_STATIC=OFF
              cmake --build . -j$(nproc)
              cmake --install .
          fi

      - name: Build for Linux ARM64
        run: |
          cmake -B build-linux-arm64-${{ matrix.build_type }} \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DCMAKE_TOOLCHAIN_FILE=cmake/aarch64-linux-gnu.cmake \
              -G Ninja
          cmake --build build-linux-arm64-${{ matrix.build_type }} --parallel

      - name: Package artifact
        run: |
          TYPE_LOWER=$(echo "${{ matrix.build_type }}" | tr 'A-Z' 'a-z')
          SUFFIX=""
          [ "$TYPE_LOWER" = "debug" ] && SUFFIX="-debug"
          mkdir -p artifacts pkg/bin pkg/lib
          cp build-linux-arm64-${{ matrix.build_type }}/3sx pkg/bin/
          cp third_party/ffmpeg/build/lib/*.so* pkg/lib/
          cp third_party/sdl3/build/lib/*.so* pkg/lib/
          cp dist/3sx.sh pkg/
          chmod +x pkg/3sx.sh pkg/bin/3sx
          cd pkg && zip -r ../artifacts/3sx-linux-arm64${SUFFIX}.zip . && cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-linux-arm64-${{ matrix.build_type }}
          path: artifacts/3sx-linux-arm64*.zip

  build-windows:
    name: Build (Windows x86_64 ${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: [Release, Debug]
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            git
            zip
            make
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-headers-git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Windows-deps-${{ hashFiles('build-deps.sh') }}

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          ./build-deps.sh

      - name: Configure and build with CMake
        run: |
          set -o pipefail
          CC=clang CXX=clang++ cmake -S . -B build-${{ matrix.build_type }} \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build-${{ matrix.build_type }} --parallel

      - name: Package artifact
        run: |
          TYPE_LOWER=$(echo "${{ matrix.build_type }}" | tr 'A-Z' 'a-z')
          SUFFIX=""
          [ "$TYPE_LOWER" = "debug" ] && SUFFIX="-debug"
          mkdir -p artifacts
          cp /mingw64/bin/libwinpthread-1.dll .
          cp /mingw64/bin/libstdc++-6.dll .
          cp /mingw64/bin/libgcc_s_seh-1.dll .
          zip -j artifacts/3sx-windows${SUFFIX}.zip build-${{ matrix.build_type }}/3sx.exe libwinpthread-1.dll libstdc++-6.dll libgcc_s_seh-1.dll third_party/ffmpeg/build/bin/*.dll third_party/sdl3/build/bin/*.dll

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-windows-${{ matrix.build_type }}
          path: artifacts/3sx-windows*.zip

  build-macos:
    name: Build (macOS Universal ${{ matrix.build_type }})
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [Release, Debug]
    env:
      TARGET_ARCH: universal
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: ${{ runner.os }}-universal-deps-${{ hashFiles('build-deps.sh') }}

      - name: Install packaging tool
        run: brew install zip

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          sh build-deps.sh

      - name: Configure and build with CMake
        run: |
          set -o pipefail
          cmake -B build-${{ matrix.build_type }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
          cmake --build build-${{ matrix.build_type }} --parallel

      - name: Package artifact
        run: |
          TYPE_LOWER=$(echo "${{ matrix.build_type }}" | tr 'A-Z' 'a-z')
          SUFFIX=""
          [ "$TYPE_LOWER" = "debug" ] && SUFFIX="-debug"
          mkdir -p artifacts
          cd build-${{ matrix.build_type }}
          zip -r ../artifacts/3sx-macos-universal${SUFFIX}.zip 3sx.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-macos-universal-${{ matrix.build_type }}
          path: artifacts/3sx-macos-universal*.zip

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-24.08
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Flatpak bundle
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: com.crowdedstreet.ThreeSX.yml
          bundle: 3sx.flatpak
          cache: true
          cache-key: flatpak-builder-${{ hashFiles('com.crowdedstreet.ThreeSX.yml') }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-flatpak
          path: 3sx.flatpak

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-linux-arm64, build-windows, build-macos, build-flatpak]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: artifacts/

      - name: Generate release tag
        id: tag
        run: |
          TAG="build-$(date -u +'%Y%m%d-%H%M%S')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Generated tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ steps.tag.outputs.tag }}"
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            artifacts/*.zip
            artifacts/*.flatpak
          body: |
            Automated release from `main`

            **Commit:** `${{ github.sha }}`

            ### Downloads (Release)
            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64 | `3sx-linux-x86_64.zip` |
            | Linux | ARM64 | `3sx-linux-arm64.zip` |
            | Windows | x86_64 | `3sx-windows.zip` |
            | macOS | Universal (arm64 + x86_64) | `3sx-macos-universal.zip` |
            | Linux (Flatpak) | x86_64 | `3sx.flatpak` |

            ### Downloads (Debug)
            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64 | `3sx-linux-x86_64-debug.zip` |
            | Linux | ARM64 | `3sx-linux-arm64-debug.zip` |
            | Windows | x86_64 | `3sx-windows-debug.zip` |
            | macOS | Universal (arm64 + x86_64) | `3sx-macos-universal-debug.zip` |
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

