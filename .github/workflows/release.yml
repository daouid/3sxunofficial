name: Create Release

on:
  push:
    branches:
      - "main"

jobs:
  build-linux:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.04
    steps:
      - name: Install Git and tools
        run: |
          apt-get update
          apt-get install -y git curl nasm

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Linux-deps-${{ hashFiles('build-deps.sh') }}

      - name: Install build dependencies
        run: |
          apt-get install -y $(cat tools/requirements-ubuntu-sdl3.txt)
          apt-get install -y clang zip

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          ./build-deps.sh

      - name: Configure and build with CMake
        run: |
          CC=clang CXX=clang++ cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      - name: Package artifact
        run: |
          mkdir -p artifacts pkg/bin pkg/lib
          cp build/3sx pkg/bin/
          cp third_party/ffmpeg/build/lib/*.so* pkg/lib/
          cp third_party/sdl3/build/lib/*.so* pkg/lib/
          cp dist/3sx.sh pkg/
          chmod +x pkg/3sx.sh pkg/bin/3sx
          cd pkg && zip -r ../artifacts/3sx-linux-x86_64.zip . && cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-linux-x86_64
          path: artifacts/3sx-linux-x86_64.zip

  build-linux-arm64:
    name: Build (Linux ARM64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache ARM64 dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Linux-arm64-deps-${{ hashFiles('build-deps.sh') }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/src -w /src \
            ubuntu:25.04 bash -c "
              apt-get update &&
              apt-get install -y git curl nasm clang zip \
                \$(cat tools/requirements-ubuntu-sdl3.txt) &&
              chmod +x build-deps.sh &&
              ./build-deps.sh &&
              CC=clang CXX=clang++ cmake -B build -DCMAKE_BUILD_TYPE=Release &&
              cmake --build build --parallel 2 &&
              mkdir -p artifacts pkg/bin pkg/lib &&
              cp build/3sx pkg/bin/ &&
              cp third_party/ffmpeg/build/lib/*.so* pkg/lib/ &&
              cp third_party/sdl3/build/lib/*.so* pkg/lib/ &&
              cp dist/3sx.sh pkg/ &&
              chmod +x pkg/3sx.sh pkg/bin/3sx &&
              cd pkg && zip -r ../artifacts/3sx-linux-arm64.zip . && cd ..
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-linux-arm64
          path: artifacts/3sx-linux-arm64.zip

  build-windows:
    name: Build (Windows x86_64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            git
            zip
            make
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-headers-git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Windows-deps-${{ hashFiles('build-deps.sh') }}

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          ./build-deps.sh

      - name: Configure and build with CMake
        run: |
          set -o pipefail
          CC=clang CXX=clang++ cmake -S . -B build \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      - name: Package artifact
        run: |
          mkdir -p artifacts
          cp /mingw64/bin/libwinpthread-1.dll .
          cp /mingw64/bin/libstdc++-6.dll .
          zip -j artifacts/3sx-windows.zip build/3sx.exe libwinpthread-1.dll libstdc++-6.dll third_party/ffmpeg/build/bin/*.dll third_party/sdl3/build/bin/*.dll

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-windows
          path: artifacts/3sx-windows.zip

  build-macos:
    name: Build (macOS Universal)
    runs-on: macos-latest
    env:
      TARGET_ARCH: universal
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: ${{ runner.os }}-universal-deps-${{ hashFiles('build-deps.sh') }}

      - name: Install packaging tool
        run: brew install zip

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          sh build-deps.sh

      - name: Configure and build with CMake
        run: |
          set -o pipefail
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
          cmake --build build --parallel

      - name: Package artifact
        run: |
          mkdir -p artifacts
          cd build
          zip -r ../artifacts/3sx-macos-universal.zip 3sx.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-macos-universal
          path: artifacts/3sx-macos-universal.zip

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-24.08
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Flatpak bundle
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: com.crowdedstreet.ThreeSX.yml
          bundle: 3sx.flatpak
          cache: true
          cache-key: flatpak-builder-${{ hashFiles('com.crowdedstreet.ThreeSX.yml') }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3sx-flatpak
          path: 3sx.flatpak

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-linux-arm64, build-windows, build-macos, build-flatpak]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: artifacts/

      - name: Generate release tag
        id: tag
        run: |
          TAG="build-$(date -u +'%Y%m%d-%H%M%S')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Generated tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ steps.tag.outputs.tag }}"
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            artifacts/*.zip
            artifacts/*.flatpak
          body: |
            Automated release from `main`

            **Commit:** `${{ github.sha }}`

            ### Downloads
            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64 | `3sx-linux-x86_64.zip` |
            | Linux | ARM64 | `3sx-linux-arm64.zip` |
            | Windows | x86_64 | `3sx-windows.zip` |
            | macOS | Universal (arm64 + x86_64) | `3sx-macos-universal.zip` |
            | Linux (Flatpak) | x86_64 | `3sx.flatpak` |
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

